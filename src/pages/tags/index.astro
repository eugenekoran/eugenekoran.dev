---
import { getCollection } from 'astro:content';
import PageLayout from '../../layouts/PageLayout.astro';
import { getSite } from '../../utils/consts';

const posts = await getCollection('blog');
const projects = await getCollection('projects');
const site = await getSite();
const slugify = (value: string) => value.toLowerCase().replace(/\s+/g, '-');

const tagCounts = new Map<string, number>();
posts.forEach((post) => {
	(post.data.tags ?? []).forEach((tag) => {
		tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
	});
});
projects.forEach((project) => {
	(project.data.tags ?? []).forEach((tag) => {
		tagCounts.set(tag, (tagCounts.get(tag) ?? 0) + 1);
	});
});

const tags = Array.from(tagCounts.entries()).sort((a, b) => {
	if (b[1] !== a[1]) return b[1] - a[1];
	return a[0].localeCompare(b[0]);
});
---

<PageLayout title={`Tags Â· ${site.title}`} description="Browse content by topic">
	<section class="content-shell py-12 space-y-6">
		<header class="space-y-2">
			<p class="text-sm uppercase tracking-[0.3em] text-muted">Tags</p>
			<h1 class="text-3xl font-semibold text-ink">Browse by topic</h1>
			<p class="text-muted">Explore all tags across projects and blog posts.</p>
		</header>

		{tags.length === 0 ? (
			<p class="text-muted">No tags yet.</p>
		) : (
			<ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
				{tags.map(([tag, count]) => (
					<li>
						<a
							class="flex items-center justify-between rounded-xl border border-[color:var(--color-border)] bg-[color:var(--color-surface)] px-4 py-3 hover:-translate-y-[1px] hover:border-[color-mix(in_oklab,var(--color-ink)_25%,transparent)] transition duration-150"
							href={`/tags/${slugify(tag)}/`}
						>
							<span class="font-medium text-ink">{tag}</span>
							<span class="text-sm text-muted">{count}</span>
						</a>
					</li>
				))}
			</ul>
		)}
	</section>
</PageLayout>
